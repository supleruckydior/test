-- 游戏 Exploit 功能脚本（精简版）
-- 只保留可能有效的客户端配置修改

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- 等待并加载 PathTool 系统
local PathTool, GamePlayer

local function WaitForPathTool()
    local maxWait = 30
    local waited = 0
    
    while not PathTool do
        local success, result = pcall(function()
            PathTool = require(ReplicatedStorage:WaitForChild("CommonLibrary"):WaitForChild("Tool"):WaitForChild("PathTool"))
        end)
        if success then
            _G.PathTool = PathTool
        end
        
        if not PathTool and _G.PathTool then
            PathTool = _G.PathTool
        end
        
        if PathTool then
            break
        end
        
        wait(0.1)
        waited = waited + 0.1
        if waited >= maxWait then
            error("PathTool 系统未找到")
        end
    end
    
    -- 等待 GamePlayer
    while not GamePlayer do
        local success, result = pcall(function()
            GamePlayer = PathTool.ClientPlayerManager.GetGamePlayer()
        end)
        if success and result then
            GamePlayer = result
            break
        end
        wait(0.5)
    end
    
    if not GamePlayer then
        error("GamePlayer 未找到")
    end
end

WaitForPathTool()

print("========================================")
print("[Exploit] 游戏 Exploit 功能系统已启动")
print("========================================")

-- ==================== Exploit 功能 ====================

local ExploitFeatures = {}

-- 1. 修改自动攻击范围（已验证有效）
ExploitFeatures.ModifyAttackRange = function(multiplier)
    multiplier = multiplier or 5  -- 默认5倍
    
    if PathTool and PathTool.CfgAutoAttack then
        local success, err = pcall(function()
            local originalRange = PathTool.CfgAutoAttack.SearchRange
            if originalRange then
                PathTool.CfgAutoAttack.SearchRange = originalRange * multiplier
                print(string.format("[Exploit] ✓ 攻击范围: %s -> %s (%.1fx)", 
                    tostring(originalRange), tostring(PathTool.CfgAutoAttack.SearchRange), multiplier))
                return true
            end
        end)
        if not success then
            warn("[Exploit] 修改攻击范围失败:", err)
        end
    else
        warn("[Exploit] CfgAutoAttack 未找到")
    end
    
    return false
end

-- 2. 修改自动攻击搜索间隔（减少间隔 = 更快攻击）
ExploitFeatures.ModifySearchInterval = function(reductionPercent)
    reductionPercent = reductionPercent or 90  -- 默认减少90%
    
    if PathTool and PathTool.CfgAutoAttack then
        local success, err = pcall(function()
            if PathTool.CfgAutoAttack.SearchIntervalTime then
                local original = PathTool.CfgAutoAttack.SearchIntervalTime
                PathTool.CfgAutoAttack.SearchIntervalTime = original * (1 - reductionPercent / 100)
                print(string.format("[Exploit] ✓ 搜索间隔: %s -> %s (减少%.0f%%)", 
                    tostring(original), tostring(PathTool.CfgAutoAttack.SearchIntervalTime), reductionPercent))
                return true
            end
        end)
        if not success then
            warn("[Exploit] 修改搜索间隔失败:", err)
        end
    end
    
    return false
end

-- 3. 修改自动捕捉延迟（减少延迟 = 更快捕捉）
ExploitFeatures.ModifyCatchDelay = function(reductionPercent)
    reductionPercent = reductionPercent or 90  -- 默认减少90%
    
    if PathTool and PathTool.CfgAutoAttack then
        local success, err = pcall(function()
            if PathTool.CfgAutoAttack.DelayAutoCatch then
                local original = PathTool.CfgAutoAttack.DelayAutoCatch
                PathTool.CfgAutoAttack.DelayAutoCatch = original * (1 - reductionPercent / 100)
                print(string.format("[Exploit] ✓ 捕捉延迟: %s -> %s (减少%.0f%%)", 
                    tostring(original), tostring(PathTool.CfgAutoAttack.DelayAutoCatch), reductionPercent))
                return true
            end
        end)
        if not success then
            warn("[Exploit] 修改捕捉延迟失败:", err)
        end
    end
    
    return false
end

-- 4. 修改自动拾取延迟（减少延迟 = 更快拾取）
ExploitFeatures.ModifyPickUpDelay = function(reductionPercent)
    reductionPercent = reductionPercent or 90  -- 默认减少90%
    
    if PathTool and PathTool.CfgAutoAttack then
        local success, err = pcall(function()
            if PathTool.CfgAutoAttack.DelayAutoPickUp then
                local original = PathTool.CfgAutoAttack.DelayAutoPickUp
                PathTool.CfgAutoAttack.DelayAutoPickUp = original * (1 - reductionPercent / 100)
                print(string.format("[Exploit] ✓ 拾取延迟: %s -> %s (减少%.0f%%)", 
                    tostring(original), tostring(PathTool.CfgAutoAttack.DelayAutoPickUp), reductionPercent))
                return true
            end
        end)
        if not success then
            warn("[Exploit] 修改拾取延迟失败:", err)
        end
    end
    
    return false
end

-- 5. 修改首次搜索延迟
ExploitFeatures.ModifyFirstSearchDelay = function(reductionPercent)
    reductionPercent = reductionPercent or 90  -- 默认减少90%
    
    if PathTool and PathTool.CfgAutoAttack then
        local success, err = pcall(function()
            if PathTool.CfgAutoAttack.FirstSearchDelay then
                local original = PathTool.CfgAutoAttack.FirstSearchDelay
                PathTool.CfgAutoAttack.FirstSearchDelay = original * (1 - reductionPercent / 100)
                print(string.format("[Exploit] ✓ 首次搜索延迟: %s -> %s (减少%.0f%%)", 
                    tostring(original), tostring(PathTool.CfgAutoAttack.FirstSearchDelay), reductionPercent))
                return true
            end
        end)
        if not success then
            warn("[Exploit] 修改首次搜索延迟失败:", err)
        end
    end
    
    return false
end

-- 深度遍历table并转换为字符串
local function TableToString(t, indent, maxDepth, visited)
    indent = indent or 0
    maxDepth = maxDepth or 10
    visited = visited or {}
    
    if indent > maxDepth then
        return "... (深度限制)"
    end
    
    -- 防止循环引用
    if visited[t] then
        return "[循环引用]"
    end
    visited[t] = true
    
    local indentStr = string.rep("  ", indent)
    local lines = {}
    
    if type(t) == "table" then
        table.insert(lines, "{")
        
        local count = 0
        local maxItems = 100  -- 限制每个table最多显示100项
        
        for k, v in pairs(t) do
            if count >= maxItems then
                table.insert(lines, indentStr .. "  ... (还有更多项)")
                break
            end
            
            local keyStr = tostring(k)
            if type(k) == "string" then
                keyStr = string.format("[%q]", k)
            elseif type(k) == "number" then
                keyStr = string.format("[%d]", k)
            end
            
            if type(v) == "table" then
                local subTable = TableToString(v, indent + 1, maxDepth, visited)
                table.insert(lines, string.format("%s  %s = %s", indentStr, keyStr, subTable))
            elseif type(v) == "string" then
                table.insert(lines, string.format("%s  %s = %q", indentStr, keyStr, v))
            elseif type(v) == "function" then
                table.insert(lines, string.format("%s  %s = [function]", indentStr, keyStr))
            else
                table.insert(lines, string.format("%s  %s = %s", indentStr, keyStr, tostring(v)))
            end
            
            count = count + 1
        end
        
        table.insert(lines, indentStr .. "}")
        return table.concat(lines, "\n")
    else
        return tostring(t)
    end
end

-- 2. 显示所有可用的配置参数并写入文件
ExploitFeatures.ShowAllConfigs = function()
    local output = {}
    table.insert(output, "========================================")
    table.insert(output, "[Exploit] 所有可用的配置参数:")
    table.insert(output, "========================================")
    table.insert(output, "")
    
    local configCount = 0
    
    -- CfgAutoAttack 配置
    if PathTool and PathTool.CfgAutoAttack then
        table.insert(output, "[CfgAutoAttack]")
        table.insert(output, "----------------------------------------")
        for k, v in pairs(PathTool.CfgAutoAttack) do
            if k ~= "__index" then
                if type(v) == "table" then
                    table.insert(output, string.format("%s = ", k))
                    table.insert(output, TableToString(v, 0, 5))
                elseif type(v) ~= "function" then
                    table.insert(output, string.format("%s = %s", k, tostring(v)))
                end
                configCount = configCount + 1
            end
        end
        table.insert(output, "")
    end
    
    -- 列出所有 PathTool 的配置模块并展开
    table.insert(output, "[PathTool 所有配置模块]")
    table.insert(output, "----------------------------------------")
    local moduleCount = 0
    for k, v in pairs(PathTool) do
        if string.find(k, "Cfg") and type(v) == "table" then
            moduleCount = moduleCount + 1
            table.insert(output, string.format("\n[%s]", k))
            table.insert(output, "----------------------------------------")
            
            -- 展开这个配置模块
            local itemCount = 0
            for tk, tv in pairs(v) do
                if tk ~= "__index" and itemCount < 50 then  -- 限制每个模块最多50项
                    if type(tv) == "table" then
                        table.insert(output, string.format("%s = ", tk))
                        table.insert(output, TableToString(tv, 0, 3))  -- 限制深度为3
                    elseif type(tv) ~= "function" then
                        table.insert(output, string.format("%s = %s", tk, tostring(tv)))
                    end
                    itemCount = itemCount + 1
                elseif itemCount >= 50 then
                    table.insert(output, string.format("... (还有更多项，已限制显示)"))
                    break
                end
            end
            table.insert(output, "")
        end
    end
    
    table.insert(output, "========================================")
    table.insert(output, string.format("总计: %d 个配置参数, %d 个配置模块", configCount, moduleCount))
    table.insert(output, "========================================")
    
    -- 写入文件
    local content = table.concat(output, "\n")
    local filename = "游戏配置参数_" .. os.time() .. ".txt"
    
    if writefile then
        writefile(filename, content)
        print(string.format("[Exploit] ✓ 配置参数已保存到文件: %s", filename))
    else
        -- 如果没有writefile，使用SaveToFile（如果有）
        if SaveToFile then
            SaveToFile(content, filename)
        else
            print("========================================")
            print("文件内容（请手动复制）:")
            print("========================================")
            print(content)
            print("========================================")
        end
    end
    
    return true
end

-- 3. 尝试修改 CfgAutoAttack 的其他参数
ExploitFeatures.ModifyAutoAttackConfig = function(paramName, value)
    if not PathTool or not PathTool.CfgAutoAttack then
        warn("[Exploit] CfgAutoAttack 未找到")
        return false
    end
    
    local success, err = pcall(function()
        if PathTool.CfgAutoAttack[paramName] ~= nil then
            local original = PathTool.CfgAutoAttack[paramName]
            PathTool.CfgAutoAttack[paramName] = value
            print(string.format("[Exploit] ✓ %s: %s -> %s", 
                paramName, tostring(original), tostring(value)))
            return true
        else
            warn(string.format("[Exploit] 参数 %s 不存在", paramName))
        end
    end)
    
    if not success then
        warn("[Exploit] 修改失败:", err)
    end
    
    return success
end

-- 4. 显示 CfgAutoAttack 的详细参数并写入文件
ExploitFeatures.ShowAutoAttackConfig = function()
    local output = {}
    table.insert(output, "========================================")
    table.insert(output, "[Exploit] CfgAutoAttack 详细配置:")
    table.insert(output, "========================================")
    table.insert(output, "")
    
    if PathTool and PathTool.CfgAutoAttack then
        for k, v in pairs(PathTool.CfgAutoAttack) do
            if k ~= "__index" then
                if type(v) == "table" then
                    table.insert(output, string.format("[%s]", k))
                    table.insert(output, TableToString(v, 0, 5))
                elseif type(v) ~= "function" then
                    table.insert(output, string.format("%s = %s", k, tostring(v)))
                end
                table.insert(output, "")
            end
        end
    else
        table.insert(output, "[错误] CfgAutoAttack 未找到")
    end
    
    table.insert(output, "========================================")
    
    -- 写入文件
    local content = table.concat(output, "\n")
    local filename = "CfgAutoAttack配置_" .. os.time() .. ".txt"
    
    if writefile then
        writefile(filename, content)
        print(string.format("[Exploit] ✓ CfgAutoAttack配置已保存到文件: %s", filename))
    else
        print("========================================")
        print("文件内容（请手动复制）:")
        print("========================================")
        print(content)
        print("========================================")
    end
    
    return true
end

-- ==================== UI 创建 ====================

local function CreateUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "GameExploitUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 350, 0, 400)
    mainFrame.Position = UDim2.new(0.5, -175, 0.5, -200)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame
    
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = titleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -60, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "游戏 Exploit 功能"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.Parent = titleBar
    
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 30, 0, 30)
    closeButton.Position = UDim2.new(1, -35, 0, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
    closeButton.Text = "×"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 20
    closeButton.BorderSizePixel = 0
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton
    
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollFrame"
    scrollFrame.Size = UDim2.new(1, -20, 1, -50)
    scrollFrame.Position = UDim2.new(0, 10, 0, 40)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 6
    scrollFrame.Parent = mainFrame
    
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 5)
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Parent = scrollFrame
    
    -- 按钮列表（只保留可能有效的功能）
    local buttons = {
        {name = "5倍攻击范围", func = function() ExploitFeatures.ModifyAttackRange(5) end, color = Color3.fromRGB(60, 180, 180)},
        {name = "10倍攻击范围", func = function() ExploitFeatures.ModifyAttackRange(10) end, color = Color3.fromRGB(60, 180, 180)},
        {name = "减少90%搜索间隔", func = function() ExploitFeatures.ModifySearchInterval(90) end, color = Color3.fromRGB(120, 180, 60)},
        {name = "减少90%捕捉延迟", func = function() ExploitFeatures.ModifyCatchDelay(90) end, color = Color3.fromRGB(120, 180, 60)},
        {name = "减少90%拾取延迟", func = function() ExploitFeatures.ModifyPickUpDelay(90) end, color = Color3.fromRGB(120, 180, 60)},
        {name = "减少90%首次搜索延迟", func = function() ExploitFeatures.ModifyFirstSearchDelay(90) end, color = Color3.fromRGB(120, 180, 60)},
        {name = "显示所有配置参数", func = function() ExploitFeatures.ShowAllConfigs() end, color = Color3.fromRGB(120, 120, 120)},
        {name = "显示攻击配置详情", func = function() ExploitFeatures.ShowAutoAttackConfig() end, color = Color3.fromRGB(100, 100, 120)},
    }
    
    local buttonHeight = 35
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, #buttons * (buttonHeight + 5))
    
    for i, btnData in ipairs(buttons) do
        local btn = Instance.new("TextButton")
        btn.Name = btnData.name
        btn.Size = UDim2.new(1, 0, 0, buttonHeight)
        btn.Position = UDim2.new(0, 0, 0, (i - 1) * (buttonHeight + 5))
        btn.BackgroundColor3 = btnData.color
        btn.Text = btnData.name
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 13
        btn.BorderSizePixel = 0
        btn.Parent = scrollFrame
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 6)
        btnCorner.Parent = btn
        
        btn.MouseButton1Click:Connect(function()
            btnData.func()
        end)
    end
    
    -- 拖动功能
    local dragging = false
    local dragStart, startPos
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            mainFrame.Position = startPos + UDim2.new(0, delta.X, 0, delta.Y)
        end
    end)
    
    game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    -- 关闭按钮
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
        print("[Exploit] UI已关闭")
    end)
    
    return screenGui
end

-- 启动
spawn(function()
    wait(1)
    CreateUI()
    print("[Exploit] UI已创建")
    print("[Exploit] 提示: 点击'显示所有配置参数'查看可调整的参数")
end)
