-- Services
local Players = game:GetService("Players")
local ReplicatedFirst = game:GetService("ReplicatedFirst")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TNet = require(ReplicatedFirst.Component.TNet)
local Config = require(ReplicatedStorage:WaitForChild('Config'))
-- æ·»åŠ ç¼ºå¤±çš„ table.find å‡½æ•°
if not table.find then
    table.find = function(t, value)
        for i, v in ipairs(t) do
            if v == value then
                return i
            end
        end
        return nil
    end
end
local player = Players.LocalPlayer
local playerGui = player:WaitForChild('PlayerGui')

-- ç”¨æˆ·é…ç½®
local TARGET_AFFIX_IDS = {}
local MAX_ENCHANT_COUNT = 200
local CURRENT_COUNT = 0
local EQUIP_ID = nil
local lockedSlots = {}

-- åˆ›å»ºä¸»UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoEnchantUI"
ScreenGui.Parent = playerGui

-- ğŸ”¹ ä¿è¯åœ¨æœ€å‰é¢æ˜¾ç¤º
ScreenGui.DisplayOrder = 999
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global


local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 650, 0, 565)
mainFrame.Position = UDim2.new(0.5, -325, 0.2, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = ScreenGui

-- æ ‡é¢˜æ 
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,30)
titleBar.BackgroundColor3 = Color3.fromRGB(50,50,50)
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Text = "é™„é­”å·¥å…·ï¼ˆæ•´åˆç‰ˆï¼‰"
titleLabel.Size = UDim2.new(1,-60,1,0)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

local closeButton = Instance.new("TextButton")
closeButton.Text = "X"
closeButton.Size = UDim2.new(0,30,1,0)
closeButton.Position = UDim2.new(1,-30,0,0)
closeButton.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeButton.TextColor3 = Color3.fromRGB(255,255,255)
closeButton.Parent = titleBar
closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- æœ€å°åŒ–æŒ‰é’®
local minimizeButton = Instance.new("TextButton")
minimizeButton.Text = "_"
minimizeButton.Size = UDim2.new(0,30,1,0)
minimizeButton.Position = UDim2.new(1,-60,0,0)
minimizeButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
minimizeButton.TextColor3 = Color3.fromRGB(255,255,255)
minimizeButton.Parent = titleBar

-- æœ€å°åŒ–åçš„æ˜¾ç¤ºæ¡†ï¼ˆä½ç½®ä¿®æ­£ï¼‰
local minimizedBox = Instance.new("TextButton")
minimizedBox.Size = UDim2.new(0,120,0,40)
minimizedBox.Position = UDim2.new(0,10,1,-50)  -- ä¿®æ­£ä¸ºå·¦ä¸Šè§’
minimizedBox.Text = "æ˜¾ç¤ºé™„é­”å·¥å…·"
minimizedBox.BackgroundColor3 = Color3.fromRGB(50,50,150)
minimizedBox.TextColor3 = Color3.fromRGB(255,255,255)
minimizedBox.Font = Enum.Font.SourceSans
minimizedBox.TextSize = 14
minimizedBox.Visible = false
minimizedBox.Parent = ScreenGui

-- ğŸ”¹ ä¿è¯æœ€å‰æ˜¾ç¤º
minimizedBox.ZIndex = 10
-- æœ€å°åŒ–/æ¢å¤åŠŸèƒ½
minimizeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    minimizedBox.Visible = true
end)

minimizedBox.MouseButton1Click:Connect(function()
    mainFrame.Visible = true
    minimizedBox.Visible = false
end)

-- å…³é—­æ—¶ä¹Ÿéšè—æœ€å°åŒ–æ¡†
closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- æœç´¢æ¡†
local searchLabel = Instance.new("TextLabel")
searchLabel.Text = "æœç´¢é™„é­”ï¼š"
searchLabel.Size = UDim2.new(0, 100, 0, 20)
searchLabel.Position = UDim2.new(0, 10, 0, 40)
searchLabel.BackgroundTransparency = 1
searchLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
searchLabel.TextXAlignment = Enum.TextXAlignment.Left
searchLabel.Parent = mainFrame

-- æœç´¢æ¡†ï¼ˆè°ƒæ•´ä½ç½®ï¼‰
local searchBox = Instance.new("TextBox")
searchBox.PlaceholderText = "è¾“å…¥å…³é”®è¯æœç´¢é™„é­”"
searchBox.Size = UDim2.new(0, 300, 0, 35)
searchBox.Position = UDim2.new(0, 80, 0, 40)
searchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
searchBox.Text = ""  -- ç¡®ä¿åˆå§‹æ–‡æœ¬ä¸ºç©º
searchBox.Font = Enum.Font.SourceSans  -- æ·»åŠ å­—ä½“
searchBox.TextSize = 14  -- æ·»åŠ æ–‡å­—å¤§å°
searchBox.Parent = mainFrame
-- æœç´¢ç»“æœæ ‡é¢˜
local resultsLabel = Instance.new("TextLabel")
resultsLabel.Text = "æœç´¢ç»“æœï¼š"
resultsLabel.Size = UDim2.new(0, 100, 0, 20)
resultsLabel.Position = UDim2.new(0, 10, 0, 80)
resultsLabel.BackgroundTransparency = 1
resultsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
resultsLabel.TextXAlignment = Enum.TextXAlignment.Left
resultsLabel.Parent = mainFrame
-- æ»šåŠ¨æœç´¢ç»“æœ
local scrollingFrame = Instance.new("ScrollingFrame")
scrollingFrame.Size = UDim2.new(0, 630, 0, 150)
scrollingFrame.Position = UDim2.new(0, 10, 0, 100)  -- è°ƒæ•´ä½ç½®
scrollingFrame.BackgroundTransparency = 1
scrollingFrame.ScrollBarThickness = 8
scrollingFrame.Parent = mainFrame

-- ç›®æ ‡é™„é­”æ ‡é¢˜
local targetLabel = Instance.new("TextLabel")
targetLabel.Text = "ç›®æ ‡é™„é­”IDï¼ˆæœ€å¤š6ä¸ªï¼‰ï¼š"
targetLabel.Size = UDim2.new(0, 200, 0, 20)
targetLabel.Position = UDim2.new(0, 10, 0, 260)
targetLabel.BackgroundTransparency = 1
targetLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
targetLabel.TextXAlignment = Enum.TextXAlignment.Left
targetLabel.Parent = mainFrame

-- é™„é­”IDè¾“å…¥æ¡†ï¼ˆä¿®æ­£ç‰ˆï¼‰
local affixInputs = {}
for i=1,6 do
    local input = Instance.new("TextBox")
    input.Size = UDim2.new(0, 300, 0, 30)
    input.Position = UDim2.new(0, 10, 0, 285 + (i-1)*35)
    input.PlaceholderText = "é™„é­”ID - ç‚¹å‡»ä¸Šæ–¹æœç´¢ç»“æœè‡ªåŠ¨å¡«å……"
    input.ClearTextOnFocus = true  -- æ¢å¤ç‚¹å‡»æ¸…ç©ºåŠŸèƒ½
    input.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    input.TextColor3 = Color3.fromRGB(255, 255, 255)
    input.Text = ""  -- ç¡®ä¿åˆå§‹æ–‡æœ¬ä¸ºç©º
    input.Font = Enum.Font.SourceSans  -- æ·»åŠ å­—ä½“
    input.TextSize = 14  -- æ·»åŠ æ–‡å­—å¤§å°
    input.Parent = mainFrame
    affixInputs[i] = input
end
-- è£…å¤‡ä¿¡æ¯æ ‡é¢˜
local equipLabel = Instance.new("TextLabel")
equipLabel.Text = "è£…å¤‡é™„é­”ä¿¡æ¯ï¼š"
equipLabel.Size = UDim2.new(0, 150, 0, 20)
equipLabel.Position = UDim2.new(0, 320, 0, 260)
equipLabel.BackgroundTransparency = 1
equipLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
equipLabel.TextXAlignment = Enum.TextXAlignment.Left
equipLabel.Parent = mainFrame


-- æ˜¾ç¤ºè£…å¤‡é™„é­”ä¿¡æ¯ï¼ˆä¿®æ­£ç‰ˆï¼‰
local AffixLabel = Instance.new("TextLabel")
AffixLabel.Size = UDim2.new(0, 300, 0, 180)
AffixLabel.Position = UDim2.new(0, 320, 0, 285)
AffixLabel.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
AffixLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
AffixLabel.TextWrapped = true
AffixLabel.TextScaled = false  -- æ”¹ä¸ºfalseï¼Œä½¿ç”¨å›ºå®šæ–‡å­—å¤§å°
AffixLabel.Font = Enum.Font.SourceSans  -- æ·»åŠ å­—ä½“
AffixLabel.TextSize = 20  -- æ·»åŠ æ–‡å­—å¤§å°
AffixLabel.Text = "ç‚¹å‡»è¯»å–è£…å¤‡æŸ¥çœ‹é™„é­”"
AffixLabel.Parent = mainFrame
-- æ‰‹åŠ¨é”å®šæ ‡é¢˜
local manualLockLabel = Instance.new("TextLabel")
manualLockLabel.Text = "æ‰‹åŠ¨é”å®šä½ç½®ï¼š"
manualLockLabel.Size = UDim2.new(0, 120, 0, 20)
manualLockLabel.Position = UDim2.new(0, 10, 0, 500)
manualLockLabel.BackgroundTransparency = 1
manualLockLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
manualLockLabel.TextXAlignment = Enum.TextXAlignment.Left
manualLockLabel.Font = Enum.Font.SourceSans
manualLockLabel.TextSize = 12
manualLockLabel.Parent = mainFrame

-- æ‰‹åŠ¨é”å®šè¾“å…¥æ¡†
local manualLockBox = Instance.new("TextBox")
manualLockBox.Size = UDim2.new(0, 200, 0, 25)
manualLockBox.Position = UDim2.new(0, 100, 0, 500)
manualLockBox.PlaceholderText = "è¾“å…¥ä½ç½®ç¼–å·ï¼Œå¦‚ï¼š1 3 4 æˆ– 1,3,4"
manualLockBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
manualLockBox.TextColor3 = Color3.fromRGB(255, 255, 255)
manualLockBox.Text = "" 
manualLockBox.Font = Enum.Font.SourceSans
manualLockBox.TextSize = 12
manualLockBox.Parent = mainFrame


-- èåˆæ¬¡æ•°æ ‡é¢˜å’Œè¾“å…¥æ¡†
local fuseLabel = Instance.new("TextLabel")
fuseLabel.Text = "æœ€å¤§èåˆæ¬¡æ•°ï¼š"
fuseLabel.Size = UDim2.new(0, 100, 0, 20)
fuseLabel.Position = UDim2.new(0, 10, 0, 530)
fuseLabel.BackgroundTransparency = 1
fuseLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
fuseLabel.TextXAlignment = Enum.TextXAlignment.Left
fuseLabel.Parent = mainFrame
-- èåˆæ¬¡æ•°è¾“å…¥æ¡†ï¼ˆä¿®æ­£ç‰ˆï¼‰
local fuseBox = Instance.new("TextBox")
fuseBox.Size = UDim2.new(0, 100, 0, 30)
fuseBox.Position = UDim2.new(0, 110, 0, 530)
fuseBox.PlaceholderText = "èåˆæ¬¡æ•°"
fuseBox.Text = tostring(MAX_ENCHANT_COUNT)
fuseBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
fuseBox.TextColor3 = Color3.fromRGB(255, 255, 255)
fuseBox.Font = Enum.Font.SourceSans  -- æ·»åŠ å­—ä½“
fuseBox.TextSize = 14  -- æ·»åŠ æ–‡å­—å¤§å°
fuseBox.Parent = mainFrame

-- é”å®šçŠ¶æ€æ ‡ç­¾ï¼ˆè°ƒæ•´ä½ç½®ï¼Œé¿å…ä¸æŒ‰é’®é‡å ï¼‰
local lockStatusLabel = Instance.new("TextLabel")
lockStatusLabel.Text = "é”å®šçŠ¶æ€ï¼šæœªé”å®šä»»ä½•ä½ç½®"
lockStatusLabel.Size = UDim2.new(0, 300, 0, 20)
lockStatusLabel.Position = UDim2.new(0, 320, 0, 455)  -- ä¸Šç§»é¿å…é‡å 
lockStatusLabel.BackgroundTransparency = 1
lockStatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
lockStatusLabel.Font = Enum.Font.SourceSans
lockStatusLabel.TextSize = 12
lockStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
lockStatusLabel.Parent = mainFrame


-- è¯»å–è£…å¤‡æŒ‰é’®ï¼ˆè°ƒæ•´ä½ç½®ï¼‰
local ReadButton = Instance.new("TextButton")
ReadButton.Size = UDim2.new(0,150,0,35)
ReadButton.Position = UDim2.new(0, 320, 0, 475)
ReadButton.Text = "è¯»å–è£…å¤‡"
ReadButton.BackgroundColor3 = Color3.fromRGB(60, 60, 200)
ReadButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ReadButton.Font = Enum.Font.SourceSans
ReadButton.TextSize = 14
ReadButton.Parent = mainFrame

-- å¼€å§‹é™„é­”æŒ‰é’®ï¼ˆè°ƒæ•´ä½ç½®ï¼‰
local StartButton = Instance.new("TextButton")
StartButton.Size = UDim2.new(0,150,0,35)
StartButton.Position = UDim2.new(0, 480, 0, 475)
StartButton.Text = "å¼€å§‹é™„é­”"
StartButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StartButton.Font = Enum.Font.SourceSans
StartButton.TextSize = 14
StartButton.Parent = mainFrame

-- æ›´æ–°é”å®šçŠ¶æ€æ˜¾ç¤ºå‡½æ•°
local function updateLockStatusDisplay()
    if #lockedSlots > 0 then
        lockStatusLabel.Text = "é”å®šä½ç½®: " .. table.concat(lockedSlots, ", ")
        lockStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)  -- ç»¿è‰²è¡¨ç¤ºå·²é”å®š
    else
        lockStatusLabel.Text = "é”å®šçŠ¶æ€ï¼šæœªé”å®šä»»ä½•ä½ç½®"
        lockStatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)  -- ç™½è‰²è¡¨ç¤ºæœªé”å®š
    end
end

-- æœç´¢åŠŸèƒ½
local function normalize(str)
    return string.lower(str:gsub("%s+",""):gsub("[%p%c]",""))
end

local function searchAffixByDescription(searchText)
    searchText = normalize(searchText)
    local results = {}
    if Config and Config.Affix and Config.Affix.Attribute then
        for affixId, affixData in pairs(Config.Affix.Attribute) do
            if type(affixData)=="table" and affixData.description then
                local description = normalize(tostring(affixData.description))
                if string.find(description,searchText) then
                    table.insert(results,{id=affixId,description=affixData.description})
                end
            end
        end
    end
    table.sort(results,function(a,b) return a.id<b.id end)
    return results
end

-- æ›´æ–°æœç´¢ç»“æœ
local function updateResults(results)
    for _,child in ipairs(scrollingFrame:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end

    local yOffset = 0
    for _,result in ipairs(results) do
        local itemFrame = Instance.new("Frame")
        itemFrame.Size = UDim2.new(1,-10,0,30)
        itemFrame.Position = UDim2.new(0,5,0,yOffset)
        itemFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
        itemFrame.Parent = scrollingFrame

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,-10,1,0)
        label.Position = UDim2.new(0,5,0,0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextYAlignment = Enum.TextYAlignment.Top
        label.Text = string.format("ID:%d æè¿°:%s",result.id,result.description)
        label.Parent = itemFrame

        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1,0,1,0)
        button.BackgroundTransparency = 1
        button.Text = ""
        button.Parent = itemFrame

        button.MouseButton1Click:Connect(function()
            for i,input in ipairs(affixInputs) do
                if input.Text=="" or input.Text=="é™„é­”ID" then
                    input.Text = string.format("%d | %s",result.id,result.description)
                    break
                end
            end
        end)

        yOffset = yOffset + 35
    end

    -- ğŸ”¹å…³é”®ï¼šè®¾ç½®CanvasSizeï¼Œè®©æ»šåŠ¨æ¡å¯ç”¨
    scrollingFrame.CanvasSize = UDim2.new(0,0,0,yOffset)
end

-- è·å–å½“å‰è£…å¤‡
local function getCurrentEquipment()
    for _, func in pairs(getgc(true)) do
        if type(func) == "function" and islclosure(func) then
            local upvalues = getupvalues(func)
            for _, v in pairs(upvalues) do
                if type(v) == "table" and rawget(v, "item") and v.item.ref then
                    return v.item -- è¿”å›æ‰¾åˆ°çš„è£…å¤‡
                end
            end
        end
    end
    return nil -- å¦‚æœæ²¡æ‰¾åˆ°
end

-- è°ƒç”¨ç¤ºä¾‹
local currentEquip = getCurrentEquipment()
if currentEquip then
    print("ğŸ’ å½“å‰è£…å¤‡ID:", currentEquip.ref)
else
    print("âŒ æ²¡æ‰¾åˆ°å½“å‰è£…å¤‡")
end



-- è·å–é™„é­”æè¿°
local function getEnchantDescription(enchantId)
    if Config and Config.Affix and Config.Affix.Attribute and Config.Affix.Attribute[enchantId] then
        return Config.Affix.Attribute[enchantId].description or "æœªçŸ¥é™„é­”"
    end
    return "æœªæ‰¾åˆ°é™„é­”ID: "..tostring(enchantId)
end

local function parseManualLockInput(inputText)
    local slots = {}
    
    if inputText == "" then
        return slots
    end
    
    -- æ”¯æŒç©ºæ ¼ã€é€—å·ã€åˆ†å·åˆ†éš”
    local pattern = "[%s,;]+"
    for slotStr in string.gmatch(inputText, "[^%s,;]+") do
        local slot = tonumber(slotStr)
        if slot and slot >= 1 and slot <= 6 then  -- å‡è®¾æœ€å¤š6ä¸ªé™„é­”ä½ç½®
            table.insert(slots, slot)
        end
    end
    
    return slots
end

-- å»é‡å‡½æ•°
local function removeDuplicates(t)
    local seen = {}
    local result = {}
    
    for _, v in ipairs(t) do
        if not seen[v] then
            seen[v] = true
            table.insert(result, v)
        end
    end
    
    return result
end

-- åˆå¹¶é”å®šä½ç½®ï¼ˆè„šæœ¬é”å®š + æ‰‹åŠ¨é”å®šï¼‰
local function mergeLockedSlots(scriptLocks, manualLocks)
    local allLocks = {}
    
    -- æ·»åŠ è„šæœ¬é”å®šçš„ä½ç½®
    for _, slot in ipairs(scriptLocks) do
        table.insert(allLocks, slot)
    end
    
    -- æ·»åŠ æ‰‹åŠ¨é”å®šçš„ä½ç½®
    for _, slot in ipairs(manualLocks) do
        table.insert(allLocks, slot)
    end
    
    -- å»é‡å¹¶æ’åº
    allLocks = removeDuplicates(allLocks)
    table.sort(allLocks)
    
    return allLocks
end

local function saveCurrentEnchant()
    if EQUIP_ID then
        print("ğŸ’¾ ä¿å­˜å½“å‰é™„é­”ç»“æœ...")
        TNet.FireServer("UseNewEquipmentAffixGroup", EQUIP_ID)
    end
end

local function smartLockAffixes(affixes)
    local newLockedSlots = {}
    
    -- ç¬¬ä¸€æ­¥ï¼šä¿æŒæ‰€æœ‰ä¹‹å‰å·²ç»é”å®šçš„ä½ç½®
    for _, slot in ipairs(lockedSlots) do
        if slot >= 1 and slot <= #affixes then
            table.insert(newLockedSlots, slot)
            print("ğŸ”’ ä¿æŒé”å®šä½ç½® " .. slot)
        end
    end
    
    -- ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ–°å‡ºç°çš„ç›®æ ‡é™„é­”å¹¶é”å®š
    for slot = 1, #affixes do
        local affixId = affixes[slot]
        
        -- å¦‚æœè¿™ä¸ªä½ç½®è¿˜æ²¡æœ‰è¢«é”å®š
        if not table.find(newLockedSlots, slot) then
            -- æ£€æŸ¥è¿™ä¸ªé™„é­”æ˜¯å¦åœ¨ç›®æ ‡åˆ—è¡¨ä¸­
            for _, targetId in ipairs(TARGET_AFFIX_IDS) do
                if affixId == targetId then
                    table.insert(newLockedSlots, slot)
                    print("ğŸ¯ å‘ç°æ–°ç›®æ ‡é™„é­”ï¼Œé”å®šä½ç½® " .. slot)
                    saveCurrentEnchant()
                    break
                end
            end
        end
    end
    
    -- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æ‰‹åŠ¨é”å®šçš„ä½ç½®
    local manualLockedSlots = parseManualLockInput(manualLockBox.Text)
    for _, slot in ipairs(manualLockedSlots) do
        if slot >= 1 and slot <= #affixes then
            if not table.find(newLockedSlots, slot) then
                table.insert(newLockedSlots, slot)
                print("ğŸ‘† æ‰‹åŠ¨é”å®šä½ç½® " .. slot)
            end
        end
    end
    
    -- æ’åºé”å®šä½ç½®
    table.sort(newLockedSlots)
    lockedSlots = newLockedSlots
    
    -- æ›´æ–°æ˜¾ç¤º
    updateLockStatusDisplay()
    
    print("ğŸ”’ å½“å‰é”å®šä½ç½®: " .. (#lockedSlots > 0 and table.concat(lockedSlots, ", ") or "æ— "))
end


-- è‡ªåŠ¨é”å®šå·²æœ‰ç›®æ ‡é™„é­”ï¼ˆå¢å¼ºç‰ˆï¼ŒåŒ…å«æ‰‹åŠ¨é”å®šï¼‰
local function autoLockExistingAffixes(item)
    if not item or not item.attributeGroup then
        return
    end
    
    local newLockedSlots = {}
    
    -- ç¬¬ä¸€æ­¥ï¼šä¿æŒå½“å‰å·²é”å®šçš„ä½ç½®
    for _, slot in ipairs(lockedSlots) do
        if item.attributeGroup[slot] then
            table.insert(newLockedSlots, slot)
            print("ğŸ”’ ä¿æŒå½“å‰é”å®šä½ç½® " .. slot)
        end
    end
    
    -- ç¬¬äºŒæ­¥ï¼šé”å®šæ‰€æœ‰åŒ…å«ç›®æ ‡é™„é­”çš„ä½ç½®
    for slot, affixId in pairs(item.attributeGroup) do
        -- å¦‚æœè¿™ä¸ªä½ç½®è¿˜æ²¡æœ‰è¢«é”å®š
        if not table.find(newLockedSlots, slot) then
            for _, targetId in ipairs(TARGET_AFFIX_IDS) do
                if affixId == targetId then
                    table.insert(newLockedSlots, slot)
                    print("ğŸ¯ é”å®šå·²æœ‰ç›®æ ‡é™„é­”ä½ç½® " .. slot)
                    break
                end
            end
        end
    end
    
    -- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æ‰‹åŠ¨é”å®šçš„ä½ç½®
    local manualLockedSlots = parseManualLockInput(manualLockBox.Text)
    for _, slot in ipairs(manualLockedSlots) do
        if slot >= 1 and slot <= 6 then  -- å‡è®¾æœ€å¤š6ä¸ªä½ç½®
            if not table.find(newLockedSlots, slot) then
                table.insert(newLockedSlots, slot)
                print("ğŸ‘† æ‰‹åŠ¨é”å®šä½ç½® " .. slot)
            end
        end
    end
    
    -- æ’åºé”å®šä½ç½®
    table.sort(newLockedSlots)
    lockedSlots = newLockedSlots
    
    -- æ›´æ–°æ˜¾ç¤º
    updateLockStatusDisplay()
    
    print("ğŸ”’ æœ€ç»ˆé”å®šä½ç½®: " .. (#lockedSlots > 0 and table.concat(lockedSlots, ", ") or "æ— "))
end
-- æ˜¾ç¤ºè£…å¤‡é™„é­”ä¿¡æ¯
local function displayAffixes(item)
    if not item then
        AffixLabel.Text = "âŒ æœªæ‰¾åˆ°è£…å¤‡"
        EQUIP_ID = nil
        return
    end
    EQUIP_ID = item.ref
    
    -- è§£ææ‰‹åŠ¨é”å®š
    local manualLocks = parseManualLockInput(manualLockBox.Text)
    
    local text = "è£…å¤‡ID: " .. EQUIP_ID .. "\né™„é­”ä¿¡æ¯:\n"
    if item.attributeGroup then
        for slot, affixId in pairs(item.attributeGroup) do
            local desc = getEnchantDescription(affixId)
            local marker = ""
            
            -- æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡é™„é­”
            for _, targetId in ipairs(TARGET_AFFIX_IDS) do
                if affixId == targetId then 
                    marker = "ğŸ¯"
                    break
                end
            end
            
            -- æ£€æŸ¥æ˜¯å¦å·²é”å®šï¼ˆè„šæœ¬é”å®šæˆ–æ‰‹åŠ¨é”å®šï¼‰
            local isScriptLocked = table.find(lockedSlots, slot)
            local isManualLocked = table.find(manualLocks, slot)
            
            if isScriptLocked then
                marker = marker .. "ğŸ”’"
            end
            if isManualLocked then
                marker = marker .. "ğŸ‘†"
            end
            
            text = text .. string.format("ä½ç½®%d: %s (%d) %s\n", slot, desc, affixId, marker)
        end
    else
        text = text .. "æ— é™„é­”ä¿¡æ¯"
    end
    
    -- æ˜¾ç¤ºæ‰‹åŠ¨é”å®šä¿¡æ¯
    if #manualLocks > 0 then
        text = text .. "\næ‰‹åŠ¨é”å®š: " .. table.concat(manualLocks, ", ")
    end
    
    AffixLabel.Text = text
end



-- ä¿å­˜é™„é­”


-- æ™ºèƒ½é™„é­”
local function checkAllSlotsAreTargetAffixes(affixes)
    -- æ£€æŸ¥æ¯ä¸ªä½ç½®æ˜¯å¦éƒ½æ˜¯ç›®æ ‡é™„é­”
    for slot = 1, #affixes do
        local affixId = affixes[slot]
        local isTarget = false
        
        -- æ£€æŸ¥è¿™ä¸ªä½ç½®çš„é™„é­”æ˜¯å¦åœ¨ç›®æ ‡åˆ—è¡¨ä¸­
        for _, targetId in ipairs(TARGET_AFFIX_IDS) do
            if affixId == targetId then
                isTarget = true
                break
            end
        end
        
        -- å¦‚æœä»»ä½•ä¸€ä¸ªä½ç½®ä¸æ˜¯ç›®æ ‡é™„é­”ï¼Œå°±è¿”å›false
        if not isTarget then
            return false, slot
        end
    end
    
    -- æ‰€æœ‰ä½ç½®éƒ½æ˜¯ç›®æ ‡é™„é­”
    return true
end

-- æ™ºèƒ½é™„é­”ï¼ˆä¿®æ­£ç‰ˆï¼‰
local function performEnchant()
    if #lockedSlots >= affixnum then
        print("âš ï¸ å·²ç»å…¨éƒ¨é”å®šï¼Œåœæ­¢é™„é­”")
        return
    end
    CURRENT_COUNT = CURRENT_COUNT + 1
    if CURRENT_COUNT > MAX_ENCHANT_COUNT then
        print("â¹ï¸ å·²è¾¾åˆ°æœ€å¤§é™„é­”æ¬¡æ•°ï¼Œåœæ­¢")
        return
    end
autoLockExistingAffixes(item)
    print(string.format("ğŸ”„ ç¬¬%d/%dæ¬¡é™„é­”ï¼Œå½“å‰é”å®š: %s", CURRENT_COUNT, MAX_ENCHANT_COUNT, 
        #lockedSlots > 0 and table.concat(lockedSlots, ", ") or "æ— "))

    TNet.InvokeServer("Equipment_Enchant", 5, function(success, ...)
        local results = {...}
        if success and #results > 0 and typeof(results[1]) == "table" then
            local affixes = results[1]
            
            -- ä¿å­˜é™„é­”å‰çš„é”å®šçŠ¶æ€
            local previousLocked = table.concat(lockedSlots, ", ")
            if previousLocked == "" then previousLocked = "æ— " end
            
            -- æ˜¾ç¤ºæœ¬æ¬¡é™„é­”ç»“æœ
            print("ğŸ“Š æœ¬æ¬¡é™„é­”ç»“æœ:")
            for i, affixId in ipairs(affixes) do
                local desc = getEnchantDescription(affixId)
                local isLocked = table.find(lockedSlots, i)
                local isTarget = false
                
                for _, targetId in ipairs(TARGET_AFFIX_IDS) do
                    if affixId == targetId then 
                        isTarget = true
                        break
                    end
                end
                
                local status = isLocked and "ğŸ”’" or "  "
                status = status .. (isTarget and "ğŸ¯" or "  ")
                
                print(string.format("  %s ä½ç½®%d: %s (%d)", status, i, desc, affixId))
            end

            -- ä½¿ç”¨æ™ºèƒ½é”å®šé€»è¾‘
            smartLockAffixes(affixes)
            
            -- æ˜¾ç¤ºé”å®šçŠ¶æ€å˜åŒ–
            local currentLocked = table.concat(lockedSlots, ", ")
            if currentLocked == "" then currentLocked = "æ— " end
            
            if currentLocked ~= previousLocked then
                print("ğŸ”„ é”å®šçŠ¶æ€å˜åŒ–: " .. previousLocked .. " â†’ " .. currentLocked)
            else
                print("ğŸ”’ é”å®šçŠ¶æ€ä¿æŒä¸å˜: " .. currentLocked)
            end
            
            -- æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯æ¡éƒ½æ˜¯ç›®æ ‡é™„é­”
            local allSlotsAreTarget, nonTargetSlot = checkAllSlotsAreTargetAffixes(affixes)
            
            if allSlotsAreTarget then
                print("ğŸ‰ æ‰€æœ‰è¯æ¡éƒ½æ˜¯ç›®æ ‡é™„é­”ï¼å®Œç¾é™„é­”å®Œæˆï¼")
                saveCurrentEnchant()
                return
            else
                print(string.format("ğŸ¯ ç»§ç»­ä¼˜åŒ–ï¼Œä½ç½® %d éœ€è¦æ”¹è¿›", nonTargetSlot))
            end
            
            wait(0.05)
            performEnchant()
        else
            print("âŒ é™„é­”å¤±è´¥æˆ–è¿”å›æ•°æ®å¼‚å¸¸ï¼Œé‡è¯•...")
            wait(0.05)
            performEnchant()
        end
    end, EQUIP_ID, lockedSlots)
end


-- è¯»å–è£…å¤‡æŒ‰é’®é€»è¾‘
ReadButton.MouseButton1Click:Connect(function()
    item = getCurrentEquipment()
    affix = item.attributeGroup
    affixnum = #affix
    if item then
        EQUIP_ID = item.ref
        displayAffixes(item)
        if #TARGET_AFFIX_IDS > 0 then
            autoLockExistingAffixes(item)
        end
        print("ğŸ“– è£…å¤‡è¯»å–æˆåŠŸï¼ŒID: " .. EQUIP_ID)
    else
        print("âŒ æœªæ‰¾åˆ°è£…å¤‡")
    end
end)

-- å¼€å§‹é™„é­”æŒ‰é’®é€»è¾‘
StartButton.MouseButton1Click:Connect(function()
    -- å…ˆæ”¶é›†ç›®æ ‡é™„é­”ID
    TARGET_AFFIX_IDS = {}
    for _, input in ipairs(affixInputs) do
        local text = input.Text
        if text ~= "" and text ~= "é™„é­”ID - ç‚¹å‡»ä¸Šæ–¹æœç´¢ç»“æœè‡ªåŠ¨å¡«å……" then
            local id = tonumber(text:match("^(%d+)"))
            if id then 
                table.insert(TARGET_AFFIX_IDS, id)
            end
        end
    end
    
    if #TARGET_AFFIX_IDS == 0 then
        print("âŒ è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªç›®æ ‡é™„é­”ID")
        return
    end
    
    print("ğŸ¯ ç›®æ ‡é™„é­”: " .. table.concat(TARGET_AFFIX_IDS, ", "))
    
    -- è·å–å½“å‰è£…å¤‡
    local currentItem = getCurrentEquipment()
    if not currentItem then
        print("âŒ æ— æ³•è·å–è£…å¤‡ä¿¡æ¯ï¼Œè¯·å…ˆè¯»å–è£…å¤‡")
        return
    end
    
    EQUIP_ID = currentItem.ref
    
    local count = tonumber(fuseBox.Text)
    if count then 
        MAX_ENCHANT_COUNT = count
        print("ğŸ“Š æœ€å¤§é™„é­”æ¬¡æ•°: " .. count)
    end
    
    -- é‡ç½®è®¡æ•°
    CURRENT_COUNT = 0

    -- ğŸ”¹ é‡ç½®é”å®šï¼Œåªä¿ç•™æ‰‹åŠ¨é”å®š
    local manualLocks = parseManualLockInput(manualLockBox.Text)
    lockedSlots = removeDuplicates(manualLocks)
    table.sort(lockedSlots)
    
    -- æ˜¾ç¤ºè£…å¤‡ä¿¡æ¯
    displayAffixes(currentItem)
    autoLockExistingAffixes(currentItem)
    -- è‡ªåŠ¨é”å®šåªåœ¨é™„é­”ç»“æœå‡ºç°ååº”ç”¨ï¼Œä¸ç´¯ç§¯ä¸Šä¸€æ¬¡çš„è‡ªåŠ¨é”å®š
    print("ğŸš€ å¼€å§‹é™„é­”...")
    performEnchant()
end)


manualLockBox:GetPropertyChangedSignal("Text"):Connect(function()
    if EQUIP_ID then
        local item = getCurrentEquipment()
        if item then
            displayAffixes(item)
            -- é‡æ–°åº”ç”¨é”å®šé€»è¾‘
            autoLockExistingAffixes(item)
        end
    end
end)
-- æœç´¢æ¡†ç›‘å¬
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
    local text = searchBox.Text
    local results = searchAffixByDescription(text)
    updateResults(results)
end)
