local ReplicatedFirst = game:GetService('ReplicatedFirst')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local TNet = require(ReplicatedFirst.Component.TNet)
local Config = require(ReplicatedStorage:WaitForChild('Config'))

local EQUIP_ID = 13370 -- è£…å¤‡ID
local MAX_ENCHANT_COUNT = 200 -- æœ€å¤§é™„é­”æ¬¡æ•°
local CURRENT_COUNT = 0 -- å½“å‰é™„é­”æ¬¡æ•°

-- é…ç½®ï¼šä½ éœ€è¦çš„ç›®æ ‡è¯æ¡IDåˆ—è¡¨
local TARGET_AFFIX_IDS = {
    --141050401, -- æ›¿æ¢ä¸ºä½ éœ€è¦çš„è¯æ¡ID
    --141060401, -- æ›¿æ¢ä¸ºä½ éœ€è¦çš„è¯æ¡ID
    --141060005,
    --141060405,
    141060006,
    141060009,
    --141060008, -- æ·»åŠ æ›´å¤šéœ€è¦çš„è¯æ¡ID
}

-- é…ç½®ï¼šåˆå§‹é”å®šçš„ä½ç½®ï¼ˆæ¯”å¦‚é”å®šå·²æœ‰çš„å¥½è¯æ¡ï¼‰
local INITIAL_LOCKED_SLOTS = { 2 } -- åˆå§‹é”å®šç¬¬2å’Œç¬¬3ä¸ªä½ç½®

-- ä¿å­˜å½“å‰é™„é­”ç»“æœçš„å‡½æ•°ï¼ˆä½¿ç”¨FireServerï¼‰
local function saveCurrentEnchant()
    print('ğŸ’¾ ä¿å­˜å½“å‰é™„é­”ç»“æœ...')
    TNet.FireServer('UseNewEquipmentAffixGroup', EQUIP_ID)
    print('âœ… ä¿å­˜è¯·æ±‚å·²å‘é€')
end

-- é™„é­”IDåˆ°æè¿°çš„å‡½æ•°
local function getEnchantDescription(enchantId)
    if
        Config
        and Config.Affix
        and Config.Affix.Attribute
        and Config.Affix.Attribute[enchantId]
    then
        local enchantData = Config.Affix.Attribute[enchantId]
        return enchantData.description or 'æœªçŸ¥é™„é­”'
    end
    return 'æœªæ‰¾åˆ°é™„é­”ID: ' .. tostring(enchantId)
end

-- æ£€æŸ¥è¯æ¡æ˜¯å¦åœ¨ç›®æ ‡åˆ—è¡¨ä¸­
local function isTargetAffix(affixId)
    for _, targetId in ipairs(TARGET_AFFIX_IDS) do
        if affixId == targetId then
            return true
        end
    end
    return false
end

-- æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å®Œç¾é™„é­”ï¼ˆæ‰€æœ‰ç›®æ ‡è¯æ¡éƒ½å‡ºç°ï¼‰
local function isPerfectEnchant(affixes)
    local targetCount = 0
    for _, affixId in ipairs(affixes) do
        if isTargetAffix(affixId) then
            targetCount = targetCount + 1
        end
    end
    return targetCount >= #affixes -- æ‰€æœ‰ç›®æ ‡è¯æ¡éƒ½å‡ºç°
end

-- æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç›®æ ‡è¯æ¡å‡ºç°ï¼ˆåªæ£€æŸ¥æœªè¢«é”å®šçš„ä½ç½®ï¼‰
local function hasNewTargetAffix(affixes, previouslyLockedSlots)
    for slot, affixId in ipairs(affixes) do
        -- åªæ£€æŸ¥æœªè¢«é”å®šçš„ä½ç½®
        local isLocked = false
        for _, lockedSlot in ipairs(previouslyLockedSlots) do
            if lockedSlot == slot then
                isLocked = true
                break
            end
        end

        -- å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰è¢«é”å®šï¼Œå¹¶ä¸”æœ‰ç›®æ ‡è¯æ¡ï¼Œæ‰è¿”å›true
        if not isLocked and isTargetAffix(affixId) then
            return true
        end
    end
    return false
end

-- åˆ†æé™„é­”ç»“æœå¹¶å†³å®šä¸‹ä¸€æ¬¡è¦é”å®šçš„ä½ç½®
local function analyzeEnchantResult(affixes, previouslyLockedSlots)
    local currentLockedSlots = {}
    local foundTargetSlots = {}

    -- é¦–å…ˆä¿ç•™ä¹‹å‰é”å®šçš„ä½ç½®
    for _, slot in ipairs(previouslyLockedSlots) do
        if slot <= #affixes then
            table.insert(currentLockedSlots, slot)
        end
    end

    -- æ£€æŸ¥æ¯ä¸ªä½ç½®çš„è¯æ¡ï¼Œå¦‚æœæ˜¯ç›®æ ‡è¯æ¡å°±é”å®šï¼ˆåªæ£€æŸ¥æœªè¢«é”å®šçš„ä½ç½®ï¼‰
    for slot, affixId in ipairs(affixes) do
        -- æ£€æŸ¥è¿™ä¸ªä½ç½®æ˜¯å¦å·²ç»è¢«é”å®š
        local alreadyLocked = false
        for _, lockedSlot in ipairs(currentLockedSlots) do
            if lockedSlot == slot then
                alreadyLocked = true
                break
            end
        end

        -- å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰è¢«é”å®šï¼Œå¹¶ä¸”æœ‰ç›®æ ‡è¯æ¡ï¼Œå°±åŠ å…¥é”å®šåˆ—è¡¨
        if not alreadyLocked and isTargetAffix(affixId) then
            table.insert(currentLockedSlots, slot)
            table.insert(foundTargetSlots, slot)
        end
    end

    -- å¯¹é”å®šä½ç½®è¿›è¡Œæ’åº
    table.sort(currentLockedSlots)

    return currentLockedSlots, foundTargetSlots
end

local function performEnchant(lockedSlots)
    CURRENT_COUNT = CURRENT_COUNT + 1

    if CURRENT_COUNT > MAX_ENCHANT_COUNT then
        print(
            string.format(
                'å·²è¾¾åˆ°æœ€å¤§é™„é­”æ¬¡æ•° %d æ¬¡ï¼Œåœæ­¢é™„é­”',
                MAX_ENCHANT_COUNT
            )
        )
        return
    end

    print(
        string.format(
            'è¿›è¡Œé™„é­”ï¼Œé”å®šä½ç½®: %s',
            table.concat(lockedSlots, ', ')
        )
    )
    print(
        string.format(
            'å½“å‰é™„é­”æ¬¡æ•°: %d/%d',
            CURRENT_COUNT,
            MAX_ENCHANT_COUNT
        )
    )

    TNet.InvokeServer('Equipment_Enchant', 5, function(success, ...)
        local results = { ... }

        if success and #results > 0 and typeof(results[1]) == 'table' then
            local affixes = results[1]
            local maxSlots = #affixes -- âœ… è£…å¤‡æœ€å¤§è¯æ¡æ•°

            -- æ‰“å°é™„é­”ç»“æœ
            for i, affixId in ipairs(affixes) do
                local description = getEnchantDescription(affixId)
                local status = 'âŒ'
                local isTarget = isTargetAffix(affixId)

                for _, lockedSlot in ipairs(lockedSlots) do
                    if lockedSlot == i then
                        status = 'ğŸ”’'
                        break
                    end
                end

                if isTarget then
                    status = status .. 'ğŸ¯'
                end

                print(
                    string.format(
                        '  %s ä½ç½®%d: %s (%d)',
                        status,
                        i,
                        description,
                        affixId
                    )
                )
            end

            -- âœ… æ–°å¢ï¼šå¦‚æœå·²é”å®šæ•° == è¯æ¡æ•°ï¼Œç›´æ¥åœæ­¢
            if #lockedSlots >= maxSlots then
                print(
                    string.format(
                        'ğŸ”’ å·²é”å®š %d/%d ä¸ªä½ç½®ï¼Œé™„é­”å®Œæˆï¼Œè‡ªåŠ¨åœæ­¢',
                        #lockedSlots,
                        maxSlots
                    )
                )
                saveCurrentEnchant()
                return
            end

            -- æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç›®æ ‡è¯æ¡
            if hasNewTargetAffix(affixes, lockedSlots) then
                print(
                    'ğŸ¯ å‘ç°æ–°çš„ç›®æ ‡è¯æ¡ï¼Œè‡ªåŠ¨ä¿å­˜å½“å‰ç»“æœ'
                )
                saveCurrentEnchant()
                wait(1)
            end

            -- æ£€æŸ¥å®Œç¾é™„é­”
            if isPerfectEnchant(affixes) then
                print('ğŸ‰ è¾¾åˆ°å®Œç¾é™„é­”ï¼è‡ªåŠ¨ä¿å­˜å¹¶åœæ­¢')
                saveCurrentEnchant()
                return
            end

            -- åˆ†æä¸‹ä¸€è½®é”å®š
            local nextLockedSlots, foundTargets =
                analyzeEnchantResult(affixes, lockedSlots)

            if #foundTargets > 0 then
                print(
                    'ğŸ¯ å‘ç°ç›®æ ‡è¯æ¡ï¼Œè‡ªåŠ¨é”å®šä½ç½®:',
                    table.concat(foundTargets, ', ')
                )
            end

            -- âœ… å†æ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…æ­»å¾ªç¯
            if #nextLockedSlots >= maxSlots then
                print(
                    string.format(
                        'ğŸ”’ å·²é”å®š %d/%d ä¸ªä½ç½®ï¼Œé™„é­”å®Œæˆï¼Œè‡ªåŠ¨åœæ­¢',
                        #nextLockedSlots,
                        maxSlots
                    )
                )
                saveCurrentEnchant()
                return
            end

            wait(0.03)
            performEnchant(nextLockedSlots)
        else
            print('é™„é­”å¤±è´¥æˆ–è¿”å›æ•°æ®å¼‚å¸¸')
            wait(0.03)
            performEnchant(lockedSlots)
        end
    end, EQUIP_ID, lockedSlots)
end

-- æ‰‹åŠ¨ä¿å­˜å‡½æ•°
local function manualSave()
    print('ğŸ”„ æ‰‹åŠ¨ä¿å­˜å½“å‰é™„é­”ç»“æœ')
    saveCurrentEnchant()
end

-- å¼€å§‹é™„é­”
print('å¼€å§‹æ™ºèƒ½é™„é­”...')
print('ç›®æ ‡è¯æ¡:')
for _, affixId in ipairs(TARGET_AFFIX_IDS) do
    local description = getEnchantDescription(affixId)
    print(string.format('  %d: %s', affixId, description))
end

print(string.format('æœ€å¤§é™„é­”æ¬¡æ•°: %d', MAX_ENCHANT_COUNT))
print("è¾“å…¥ 'manualSave()' å¯ä»¥æ‰‹åŠ¨ä¿å­˜å½“å‰é™„é­”ç»“æœ")
performEnchant(INITIAL_LOCKED_SLOTS)
